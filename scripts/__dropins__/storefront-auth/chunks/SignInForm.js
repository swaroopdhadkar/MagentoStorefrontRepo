import{jsx as c,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as $,classes as z}from"@dropins/tools/lib.js";import{g as V,c as y,u as O,T as R,F as tt,B as K}from"./useInLineAlert.js";import{useState as h,useCallback as E,useEffect as J,useMemo as at}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as st}from"./getCustomerToken.js";import{r as rt}from"./resendConfirmationEmail.js";import{s as et,a as ot}from"./simplifyTransformAttributesForm.js";import{c as it}from"./confirmEmail.js";import{useText as Q}from"@dropins/tools/i18n.js";import{InLineAlert as nt,InputPassword as ct}from"@dropins/tools/components.js";import{E as mt}from"./EmailConfirmationForm.js";const ut=({emailConfirmationStatusMessage:t,translations:e,initialEmailValue:i,routeSignUp:m,routeForgotPassword:u,routeRedirectOnSignIn:F,onErrorCallback:g,setActiveComponent:a,onSuccessCallback:l,onSignUpLinkClick:d,handleSetInLineAlertProps:s,routeRedirectOnEmailConfirmationClose:N})=>{const[P,L]=h(""),[f,x]=h(!1),[w,_]=h(""),[C,b]=h(!1),[M,S]=h({userName:"",status:!1}),[p,I]=h(!1),[B,T]=h([]),k=E(async o=>{s(),x(!0),b(!1),T([]),await rt(o)},[s]),U=E(o=>{o.length?b(!1):b(!0),_(o)},[]);J(()=>{t!=null&&t.text&&s({text:t.text,type:t.status?t.status:void 0})},[t,s]);const v=E(async o=>{var q;s(),I(!0);const n=V(o.target);if(n.password||(b(!0),I(!1)),n!=null&&n.email&&(n!=null&&n.password)){const{email:G,password:Y}=n,r=await st({email:G,password:Y,handleSetInLineAlertProps:s,onErrorCallback:g,translations:e});if((q=r==null?void 0:r.errorMessage)!=null&&q.length){L(G);const H=r.errorMessage.includes("This account isn't confirmed. Verify and try again."),Z=H?e.resendEmailInformationText:r.errorMessage;T(H?[{label:e.resendEmailButtonText,onClick:()=>{k(G)}}]:[]),s({text:Z,type:"error"}),_("")}r!=null&&r.userName&&(o.target.reset(),y(F)?window.location.href=F():(l==null||l({userName:r==null?void 0:r.userName,status:!0}),S({userName:r==null?void 0:r.userName,status:!0}))),b(!1)}I(!1)},[s,g,e,k,F,l]),j=E(()=>{if(y(a)){a("resetPasswordForm");return}y(u)&&(window.location.href=u())},[u,a]),D=E(()=>{if(y(d)&&d(),y(a)){a("signUpForm");return}y(m)&&(window.location.href=m())},[d,m,a]),W=at(()=>{const o=et(ot);return i!=null&&i.length?o==null?void 0:o.map(n=>({...n,defaultValue:i})):o},[i]),X=E(()=>{s(),y(N)?window.location.href=N():x(!1)},[s,N]);return{additionalActionsAlert:B,userEmail:P,defaultEnhancedEmailFields:W,passwordError:C,isSuccessful:M,isLoading:p,signInPasswordValue:w,showEmailConfirmationForm:f,setShowEmailConfirmationForm:x,setSignInPasswordValue:_,submitLogInUser:v,forgotPasswordCallback:j,onSignUpLinkClickCallback:D,handledOnPrimaryButtonClick:X,handleSetPassword:U}},lt=()=>{let t=new URL(window.location.href),e=t.searchParams.get("email"),i=t.searchParams.get("key");e&&i&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},ft=({enableEmailConfirmation:t})=>{const e=Q({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[i,m]=h({text:"",status:""});return J(()=>{if(t){const{search:u}=window.location;u.includes("email=")&&u.includes("key=")&&(async()=>{var l,d,s;const g=new URLSearchParams(u),a=await it({customerEmail:g.get("email"),customerConfirmationKey:g.get("key")});if(!a)return null;(l=a==null?void 0:a.errors)!=null&&l.length?m({text:a==null?void 0:a.errors[0].message,status:"error"}):(m({text:a.data.confirmEmail.customer.email?e.accountConfirmationEmailSuccessMessage.replace("{email}",(s=(d=a==null?void 0:a.data)==null?void 0:d.confirmEmail.customer)==null?void 0:s.email):e.accountConfirmMessage,status:"success"}),lt())})()}},[t,e]),{emailConfirmationStatusMessage:i}},pt=({slots:t,formSize:e="default",initialEmailValue:i="",renderSignUpLink:m=!1,enableEmailConfirmation:u=!1,hideCloseBtnOnEmailConfirmation:F=!1,routeRedirectOnEmailConfirmationClose:g,routeRedirectOnSignIn:a,routeForgotPassword:l,routeSignUp:d,onSuccessCallback:s,setActiveComponent:N,onErrorCallback:P,onSignUpLinkClick:L})=>{const f=Q({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{emailConfirmationStatusMessage:x}=ft({enableEmailConfirmation:u}),{inLineAlertProps:w,handleSetInLineAlertProps:_}=O(),{userEmail:C,additionalActionsAlert:b,defaultEnhancedEmailFields:M,passwordError:S,isSuccessful:p,isLoading:I,signInPasswordValue:B,showEmailConfirmationForm:T,submitLogInUser:k,forgotPasswordCallback:U,onSignUpLinkClickCallback:v,handledOnPrimaryButtonClick:j,handleSetPassword:D}=ut({translations:f,emailConfirmationStatusMessage:x,initialEmailValue:i,routeSignUp:d,routeForgotPassword:l,routeRedirectOnSignIn:a,setActiveComponent:N,onErrorCallback:P,onSuccessCallback:s,onSignUpLinkClick:L,handleSetInLineAlertProps:_,routeRedirectOnEmailConfirmationClose:g});return p.status&&(t!=null&&t.SuccessNotification)?c($,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:p}}):T?c(mt,{formSize:e,userEmail:C,inLineAlertProps:w,hideCloseBtnOnEmailConfirmation:F,handleSetInLineAlertProps:_,onPrimaryButtonClick:j}):A("div",{className:z(["auth-signInForm",e]),"data-testid":"signInForm",children:[c(R,{text:f.title,bottomLine:!1,className:"auth-signInForm__title"}),w.text?c(nt,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:w.type,variant:"secondary",heading:w.text,icon:w.icon,additionalActions:b}):null,A(tt,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:k,isLoading:I,fieldsConfig:M,children:[c(ct,{hideStatusIndicator:!0,className:"auth-signInForm__form__password",autoComplete:"current-password",error:S,defaultValue:B,onValue:D,placeholder:f.placeholder,floatingLabel:f.floatingLabel}),A("div",{className:"auth-signInForm__form__buttons",children:[A("div",{className:"auth-signInForm__form__buttons--combine",children:[c(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:f.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:U,"data-testid":"switchToSignUp"}),m?c("span",{}):null,m?c(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:f.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:v}):null]}),c(K,{type:"submit",buttonText:f.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:I})]})]}),c("div",{id:"generateCustomerToken"})]})};export{pt as S};
